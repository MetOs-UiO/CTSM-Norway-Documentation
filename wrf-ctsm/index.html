<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WRF-CTSM &mdash; CTSM-Norway  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" />
      <link rel="stylesheet" type="text/css" href="../_static/style.css" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Tips for developing CTSM" href="../develop/" />
    <link rel="prev" title="Spin-up CTSM" href="../spinup/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            CTSM-Norway
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Prerequisite</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prerequisite/">Prerequisites</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick-start/">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-start-single-point/">Single Point Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get/">Get CTSM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run/">Run CTSM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spinup/">Spin-up CTSM</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">WRF-CTSM</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#clone-wrf-and-ctsm-repositories">3.4.1.1. Clone WRF and CTSM Repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-ctsm">3.4.1.2 Building CTSM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-wrf-with-ctsm">3.4.1.3. Building WRF with CTSM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-wps">3.4.1.4 Building WPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-wps-programs">3.4.1.5. Run WPS Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-real-exe">3.4.1.6. Run real.exe</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-mapping-files-domains-and-surface-data">Creating a mapping files, domains and surface data.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-mapping-files">Creating Mapping files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-domains">Generating domains:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-surface-data">Generating Surface data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../develop/">Tips for developing CTSM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../license/">Credit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribution/">Contribution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">CTSM-Norway</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">WRF-CTSM</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/MetOs-UiO/CTSM-Norway-Documentation/blob/main/content/wrf-ctsm.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="wrf-ctsm">
<h1>WRF-CTSM<a class="headerlink" href="#wrf-ctsm" title="Permalink to this heading"></a></h1>
<div class="admonition-info keypoints admonition" id="keypoints-0">
<p class="admonition-title">Info</p>
<p>A detailed documentation](https://escomp.github.io/ctsm-docs/versions/master/html/lilac/specific-atm-models/index.html)] about how to set up and run CTSM with WRF can be found in the original.</p>
</div>
<p>What follows here is a modified version of that workflow that works on the SIGMA2 HPC systems (As of right now Fram with some parts having to be run on Saga).</p>
<section id="clone-wrf-and-ctsm-repositories">
<h2>3.4.1.1. Clone WRF and CTSM Repositories<a class="headerlink" href="#clone-wrf-and-ctsm-repositories" title="Permalink to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/HOME]$ git clone https://github.com/wrf-model/WRF.git WRF-CTSM
[~/HOME]$ cd WRF-CSTM
[~/WRF-CTSM]$ git checkout develop


[~/WRF-CTSM]$ git clone https://github.com/NorESMhub/CTSM.git
[~/WRF-CTSM]$ cd CTSM
[~/WRF-CTSM/CTSM]$ git checkout ctsm5.1.dev151-noresm_v1
[~/WRF-CTSM/CTSM]$ ./manage_externals/checkout_externals
</pre></div>
</div>
<p>change the content of WRF-CTSM/CTSM/src/cpl/utils/lnd_import_export_utils.F90 and WRF-CTSM/phys/module_sf_mynn.F</p>
<p>WRF-CTSM/phys/module_sf_mynn.F from line 1147 should look like this (that is insert the if-blocks in the middle):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Q2(I)=QSFCMR(I)+(QV1D(I)-QSFCMR(I))*PSIQ2/PSIQ
    Q2(I)= MAX(Q2(I), MIN(QSFCMR(I), QV1D(I)))
    Q2(I)= MIN(Q2(I), 1.05*QV1D(I))

    IF (Q2(I) .LT. 0.0) THEN
        print*,&quot;DEBUG: NEGATIVE Q2 VALUE IN MYNN SFCLAYER&quot;,&amp;
        I,J, &quot;Q2: &quot;,Q2(I)
        print*,&quot;WARNING: NEGATIVE Q2 SET TO ZERO&quot;
        Q2(I)=0.0
    ENDIF
    IF (QSFC(I) .LT. 0.0) THEN
        print*,&quot;DEBUG: NEGATIVE QSFC VALUE IN MYNN SFCLAYER&quot;,&amp;
        I,J, &quot;QSFC: &quot;,QSFC(I)
    ENDIF

    IF ( debug_code ) THEN
        yesno = 0
</pre></div>
</div>
<p>WRF-CTSM/CTSM/src/cpl/utils/lnd_import_export_utils.F90 from line 128 should look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>   end if
   if ( wateratm2lndbulk_inst%forc_q_not_downscaled_grc(g) &lt; 0.0_r8 )then
     write(iulog,*) &#39;Value of wateratm2 = &#39;, wateratm2lndbulk_inst%forc_q_not_downscaled_grc(g)  
     write(iulog,*) &#39;Value of g = &#39;, g
     !call shr_sys_abort( subname//&amp;                                                                                                                                                                          
     !     &#39; ERROR: Bottom layer specific humidty sent from the atmosphere model is less than zero&#39; )  
   end if
end do
</pre></div>
</div>
</section>
<section id="building-ctsm">
<h2>3.4.1.2 Building CTSM<a class="headerlink" href="#building-ctsm" title="Permalink to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM]$ ./lilac/build_ctsm ctsm_build_dir --compiler intel --machine fram
</pre></div>
</div>
</section>
<section id="building-wrf-with-ctsm">
<h2>3.4.1.3. Building WRF with CTSM<a class="headerlink" href="#building-wrf-with-ctsm" title="Permalink to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM]$ source ctsm_build_dir/ctsm_build_environment.sh
[~/WRF-CTSM/CTSM]$ export WRF_CTSM_MKFILE=/cluster/home/$USER/WRF-CTSM/CTSM/ctsm_build_dir/bld/ctsm.mk
</pre></div>
</div>
<div class="admonition-netcdf discussion important admonition" id="discussion-0">
<p class="admonition-title">NETCDF</p>
<p>In addition to the described steps, it is necessary to set the path to the Fortran NetCDF on FRAM before running <code class="docutils literal notranslate"><span class="pre">./configure</span></code>.</p>
</div>
<p>Set the path variables</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM]$ export NETCDF=${EBROOTNETCDFMINFORTRAN}
[~/WRF-CTSM/CTSM]$ export NETCDF_classic=1
[~/WRF-CTSM/CTSM]$ cd ..
[~/WRF-CTSM]$ ./clean -a
[~/WRF-CTSM/CTSM]$ ./configure
</pre></div>
</div>
<p>When running <code class="docutils literal notranslate"><span class="pre">./configure</span></code> you will be asked for a set of compiler options [1-75]. A good choice is 16. followed by 1 as the nesting option.</p>
<div class="admonition-compiling-wrf discussion important admonition" id="discussion-1">
<p class="admonition-title">Compiling WRF</p>
<p>Compiling WRF takes a long time. Therefore, you should put the compiling job into the background. If your connection to FRAM breaks the job will still run!</p>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM]$ nohup ./compile em_real 2&gt;&amp;1 &gt; compile.log &amp; 
</pre></div>
</div>
</section>
<section id="building-wps">
<h2>3.4.1.4 Building WPS<a class="headerlink" href="#building-wps" title="Permalink to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM]$ git clone https://github.com/wrf-model/WPS
[~/WRF-CTSM]$ cd WPS
[~/WRF-CTSM/WPS]$ git checkout v4.3
[~/WRF-CTSM/WPS]$ export WRF_DIR=../
[~/WRF-CTSM/WPS]$ ./configure
</pre></div>
</div>
<p>The automatic creation of the configuration (option 19 is a good choice) fails to recognize the compilers, therefore you have to make some changes in <code class="docutils literal notranslate"><span class="pre">configure.wps</span></code> manually.</p>
<p>Change</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DM_FC= mpiifort
DM_CC= mpiicc
</pre></div>
</div>
<p>and add <code class="docutils literal notranslate"><span class="pre">-qopenmp</span></code> to the end of the line which reads <code class="docutils literal notranslate"><span class="pre">LDFLAGS</span></code>.
Because <code class="docutils literal notranslate"><span class="pre">jasper</span></code> is one of the compiler options you have to load two additional modules beforehand</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/WPS]$ ml JasPer/2.0.33-GCCcore-11.3.0
[~/WRF-CTSM/WPS]$ ml libpng/1.6.37-GCCcore-11.3.0
[~/WRF-CTSM/WPS]$ ml CMake/3.23.1-GCCcore-11.3.0
[~/WRF-CTSM/WPS]$ ml PnetCDF/1.12.3-iimpi-2022a
[~/WRF-CTSM/WPS]$ ./compile &gt;&amp; compile.log
</pre></div>
</div>
<p>If ungrib.exe is not created just do a module purge and load everything except libpng and compile again.</p>
</section>
<section id="run-wps-programs">
<h2>3.4.1.5. Run WPS Programs<a class="headerlink" href="#run-wps-programs" title="Permalink to this heading"></a></h2>
<p>To create boundary conditions use the WPS programs. This is an example using ERA5 data for a 48 hour run from from October 6th-8th 2016.</p>
<p>Edit the &amp;share section of namelist.wps :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&amp;share
 wrf_core = &#39;ARW&#39;,
 max_dom = 1,
 start_date = &#39;2016-10-06_00:00:00&#39;,
 end_date   = &#39;2016-10-08_00:00:00&#39;,
 interval_seconds = 21600
/
</pre></div>
</div>
<p>Link the appropriate table to the folder, for ERA5 this is the ECMWF table. For other data google will be your friend.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/WPS]$ ln -sf ungrib/Variable_Tables/Vtable.ECMWF Vtable
</pre></div>
</div>
<p>make a folder for the data you need and link the data there :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/WPS]$ mkdir ../DATA
[~/WRF-CTSM/WPS]$ cd ../DATA
[~/WRF-CTSM/DATA]$ ln -sf /cluster/shared/wrf/climate/ERA5_EUR/ERA5_grib1_2016/*20161006* .
[~/WRF-CTSM/DATA]$ ln -sf /cluster/shared/wrf/climate/ERA5_EUR/ERA5_grib1_2016/*20161007* .
[~/WRF-CTSM/DATA]$ ln -sf /cluster/shared/wrf/climate/ERA5_EUR/ERA5_grib1_2016/*20161008* .
</pre></div>
</div>
<p>Link the grib data:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/WPS]$ ./link_grib.csh ../DATA/
</pre></div>
</div>
<p>Rung ungrib.exe</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/WPS]$ ./ungrib.exe
</pre></div>
</div>
<p>Edit the geogrid-setion of namelist.wps to fit your domain and , here a portion of South Norway:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&amp;geogrid
 parent_id         =   1,
 parent_grid_ratio =   1, 
 i_parent_start    =   1,
 j_parent_start    =   1,
 e_we              =   121,
 e_sn              =   91,
 geog_data_res = &#39;default&#39;,
 dx = 5000,
 dy = 5000,
 map_proj = &#39;mercator&#39;,
 ref_lat   =  61.6,
 ref_lon   =   9.4,
 truelat1  =  30.0,
 truelat2  =  60.0,
 stand_lon =   0,
 geog_data_path = &#39;/cluster/shared/wrf/geog&#39;
/
</pre></div>
</div>
<p>Run Geogrid and metgrid</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/WPS]$ mpirun -np 2 ./geogrid.exe
[~/WRF-CTSM/WPS]$ mpirun -np 2 ./metgrid.exe
</pre></div>
</div>
</section>
<section id="run-real-exe">
<h2>3.4.1.6. Run real.exe<a class="headerlink" href="#run-real-exe" title="Permalink to this heading"></a></h2>
<p>Link the metfiles to the run directory.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/run]$ ln -sf ../WPS/met_em.d* .
</pre></div>
</div>
<p>Edit namelist.input sections time_control and domains so i fits your times and your domain. Here:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&amp;time_control
run_days                            = 0,
run_hours                           = 48,
run_minutes                         = 0,
run_seconds                         = 0,
start_year                          = 2016,
start_month                         = 10,   
start_day                           = 06,  
start_hour                          = 00,  
end_year                            = 2016,
end_month                           = 10,  
end_day                             = 08,  
end_hour                            = 00, 
interval_seconds                    = 21600,
input_from_file                     = .true.,
history_interval                    = 180,
frames_per_outfile                  = 1000,
restart                             = .false.,
restart_interval                    = 1449,
io_form_history                     = 2
io_form_restart                     = 2
io_form_input                       = 2
io_form_boundary                    = 2
/

&amp;domains
time_step                           = 90,
time_step_fract_num                 = 0,
time_step_fract_den                 = 1,
max_dom                             = 1,
e_we                                = 121,  
e_sn                                = 91,   
e_vert                              = 35,
!dzstretch_s                         = 1.1
p_top_requested                     = 5000,
num_metgrid_levels                  = 38,
num_metgrid_soil_levels             = 4,
dx                                  = 5000,
dy                                  = 5000,
grid_id                             = 1,     
parent_id                           = 0,     
i_parent_start                      = 1,     
j_parent_start                      = 1,     
parent_grid_ratio                   = 1,     
parent_time_step_ratio              = 1,   
feedback                            = 1,
smooth_option                       = 0
/
</pre></div>
</div>
<p>run real.exe</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/run]$ mpirun -np 2 ./real.exe
</pre></div>
</div>
<p>Check rsl.error.0000 for the line “real_em: SUCCESS COMPLETE REAL_EM INIT” to know if the program successfully completed.</p>
</section>
<section id="creating-a-mapping-files-domains-and-surface-data">
<h2>Creating a mapping files, domains and surface data.<a class="headerlink" href="#creating-a-mapping-files-domains-and-surface-data" title="Permalink to this heading"></a></h2>
<p>The first part of this step has do be done on saga currently as saga has the modules NCL and NCO installed. So log in  to saga and install CTSM as above.</p>
<section id="creating-mapping-files">
<h3>Creating Mapping files<a class="headerlink" href="#creating-mapping-files" title="Permalink to this heading"></a></h3>
<p>Copy geo_em.d01.nc to Saga for instance done from Saga:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~]$ scp gunnartl@fram.sigma2.no:~/WRF-CTSM/WPS/geo_em.d01.nc .
</pre></div>
</div>
<p>cd to the contrib folder</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~]$ cd WRF-CTSM/CTSM/tools/contrib
</pre></div>
</div>
<p>and edit create_scrip_file.ncl to fit the newly added geo_em file.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>line 15ish: wrf_file  = addfile(&quot;~/geo_em.d01.nc&quot;, &quot;r&quot;)
</pre></div>
</div>
<p>laod NCL and run create_scrip_file.ncl</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM/tools/contrib]$ ml NCL/6.6.2-foss-2021a
[~/WRF-CTSM/CTSM/tools/contrib]$ ncl create_scrip_file.ncl
</pre></div>
</div>
<p>this creates two files: wrf2clm_land.nc and wrf2clm_ocean.nc. Now cd to ../site_and_regional where the lines 74-78 are commented out in mkunitymap.ncl:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>;if ( any(ncb-&gt;grid_imask .ne. 1.0d00) )then
;   print( &quot;ERROR: the mask of the second file isn&#39;t identically 1!&quot; );
;   print( &quot;(second file should be land grid file)&quot;);
;   exit
;end if
</pre></div>
</div>
<p>set the names of the inputfiles just created and the name of the outputfile:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM/tools/contrib]$ export GRIDFILE1=&#39;/cluster/home/$USER/WRF-CTSM/CTSM/tools/contrib/wrf2clm_ocean.nc&#39;
[~/WRF-CTSM/CTSM/tools/contrib]$ export GRIDFILE2=&#39;/cluster/home/$USER/WRF-CTSM/CTSM/tools/contrib/wrf2clm_land.nc&#39;
[~/WRF-CTSM/CTSM/tools/contrib]$ export MAPFILE=&#39;wrf2clm_mapping.nc&#39;
[~/WRF-CTSM/CTSM/tools/contrib]$ PRINT=TRUE
[~/WRF-CTSM/CTSM/tools/contrib]$ ncl mkunitymap.ncl
</pre></div>
</div>
<p>cd to ../mkmapdata and create the file regridbatch.sh that looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
#
#
# Batch script to submit to create mapping files for all standard
# resolutions.  If you provide a single resolution via &quot;$RES&quot;, only
# that resolution will be used. In that case: If it is a regional or
# single point resolution, you should set &#39;#PBS -n&#39; to 1, and be sure
# that &#39;-t regional&#39; is specified in cmdargs.
#
#SBATCH --account=nn2806k 
#SBATCH --job-name=mkmapdata
#SBATCH --mem-per-cpu=124G
#SBATCH --ntasks=1
#SBATCH --time=03:00:00

source /cluster/bin/jobsetup
module load ESMF/8.1.1-foss-2021a
module load NCO/5.0.1-foss-2021a
module load NCL/6.6.2-foss-2021a

export ESMF_NETCDF_LIBS=&quot;-lnetcdff -lnetcdf -lnetcdf_c++&quot;
#export ESMF_DIR=/usit/abel/u1/huit/ESMF/esmf
export ESMF_COMPILER=intel
export ESMF_COMM=openmpi
#export ESMF_NETCDF=&quot;test&quot;
export ESMF_NETCDF_LIBPATH=/cluster/software/ESMF/8.1.1-foss-2021a/lib
export ESMF_NETCDF_INCLUDE=/cluster/software/ESMF/8.1.1-foss-2021a/include
ulimit -s unlimited

export ESMFBIN_PATH=/cluster/software/ESMF/8.1.1-foss-2021a/bin
export CSMDATA=/cluster/shared/noresm/inputdata
export MPIEXEC=mpirun

RES=1x1
GRIDFILE=/cluster/home/gunnartl/WRF-CTSM/CTSM/tools/contrib/wrf2clm_land.nc
phys=&quot;clm4_5&quot;

#----------------------------------------------------------------------
# Set parameters
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# Begin main script
#----------------------------------------------------------------------

if [ -z &quot;$RES&quot; ]; then
echo &quot;Run for all valid resolutions&quot;
resols=`../../bld/queryDefaultNamelist.pl -res list -silent`
if [ ! -z &quot;$GRIDFILE&quot; ]; then
    echo &quot;When GRIDFILE set RES also needs to be set for a single resolution&quot;
    exit 1
fi
else
resols=&quot;$RES&quot;
fi
if [ -z &quot;$GRIDFILE&quot; ]; then
grid=&quot;&quot;
else
if [[ ${#resols[@]} &gt; 1 ]]; then
    echo &quot;When GRIDFILE is specificed only one resolution can also be given (# resolutions ${#resols[@]})&quot;
    echo &quot;Resolutions input is: $resols&quot;
    exit 1
fi
grid=&quot;-f $GRIDFILE&quot;
fi

if [ -z &quot;$MKMAPDATA_OPTIONS&quot; ]; then
echo &quot;Run with standard options&quot;
options=&quot; &quot;
else
options=&quot;$MKMAPDATA_OPTIONS&quot;
fi
echo &quot;Create mapping files for this list of resolutions: $resols&quot;

#----------------------------------------------------------------------

for res in $resols; do
echo &quot;Create mapping files for: $res&quot;
#----------------------------------------------------------------------
cmdargs=&quot;-r $res $grid $options&quot;

# For single-point and regional resolutions, tell mkmapdata that
# output type is regional
if [[ `echo &quot;$res&quot; | grep -c &quot;1x1&quot;` -gt 0 || `echo &quot;$res&quot; | grep -c &quot;5x5_&quot;` -gt 0 ]]; then
    res_type=&quot;regional&quot;
else
    res_type=&quot;global&quot;
fi
# Assume if you are providing a gridfile that the grid is regional
if [ $grid != &quot;&quot; ];then
    res_type=&quot;regional&quot;
fi

cmdargs=&quot;$cmdargs -t $res_type&quot;

echo &quot;$res_type&quot;
if [ &quot;$res_type&quot; = &quot;regional&quot; ]; then
    echo &quot;regional&quot;
    # For regional and (especially) single-point grids, we can get
    # errors when trying to use multiple processors - so just use 1.
    # We also do NOT set batch mode in this case, because some
    # machines (e.g., yellowstone) do not listen to REGRID_PROC, so to
    # get a single processor, we need to run mkmapdata.sh in
    # interactive mode.
    regrid_num_proc=1
else
    echo &quot;global&quot;
    regrid_num_proc=8
    if [ ! -z &quot;$LSFUSER&quot; ]; then
        echo &quot;batch&quot;
    cmdargs=&quot;$cmdargs -b&quot;
    fi
    if [ ! -z &quot;$PBS_O_WORKDIR&quot; ]; then
        cd $PBS_O_WORKDIR
    cmdargs=&quot;$cmdargs -b&quot;
    fi
fi

echo &quot;args: $cmdargs&quot;
echo &quot;time env REGRID_PROC=$regrid_num_proc ./mkmapdata.sh $cmdargs\n&quot;
time env REGRID_PROC=$regrid_num_proc ./mkmapdata.sh $cmdargs
done
</pre></div>
</div>
<p>Submit the job :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM/tools/mkmapdata]$ sbatch regridbatch.sh
</pre></div>
</div>
<p>This will take some hours depending on the size and resolution of your domain you might have to change the available memory per cpu and allocated time and such.
ie. :</p>
<p>#SBATCH –mem-per-cpu=128G –partition=bigmem<br />
#SBATCH –ntasks=8<br />
#SBATCH –time=15:00:00</p>
<p>When this is done you should copy the resulting files back to fram and place them in the corresponding directories there, and the rest is fiished on Fram.</p>
</section>
<section id="generating-domains">
<h3>Generating domains:<a class="headerlink" href="#generating-domains" title="Permalink to this heading"></a></h3>
<p>Create a file in ~/WRF-CTSM/CTSM/cime/tools named configure that contains this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/usr/bin/env python3

&quot;&quot;&quot;This script writes CIME build information to a directory.

The pieces of information that will be written include:

1. Machine-specific build settings (i.e. the &quot;Macros&quot; file).
2. File-specific build settings (i.e. &quot;Depends&quot; files).
3. Environment variable loads (i.e. the env_mach_specific files).

The .env_mach_specific.sh and .env_mach_specific.csh files are specific to a
given compiler, MPI library, and DEBUG setting. By default, these will be the
machine&#39;s default compiler, the machine&#39;s default MPI library, and FALSE,
respectively. These can be changed by setting the environment variables
COMPILER, MPILIB, and DEBUG, respectively.
&quot;&quot;&quot;

# pylint: disable=W1505

import os
import sys

real_file_dir = os.path.dirname(os.path.realpath(__file__))
cimeroot = os.path.abspath(os.path.join(real_file_dir, &quot;..&quot;))
sys.path.insert(0, cimeroot)

from CIME.Tools.standard_script_setup import *
from CIME.utils import expect, get_model
from CIME.BuildTools.configure import configure
from CIME.XML.machines import Machines

logger = logging.getLogger(__name__)


def parse_command_line(args):
    &quot;&quot;&quot;Command line argument parser for configure.&quot;&quot;&quot;
    description = __doc__
    parser = argparse.ArgumentParser(description=description)
    CIME.utils.setup_standard_logging_options(parser)

    parser.add_argument(
        &quot;--machine&quot;, help=&quot;The machine to create build information for.&quot;
    )
    parser.add_argument(
        &quot;--machines-dir&quot;,
        help=&quot;The machines directory to take build information &quot;
        &quot;from. Overrides the CIME_MODEL environment variable, &quot;
        &quot;and must be specified if that variable is not set.&quot;,
    )
    parser.add_argument(
        &quot;--macros-format&quot;,
        action=&quot;append&quot;,
        choices=[&quot;Makefile&quot;, &quot;CMake&quot;],
        help=&quot;The format of Macros file to generate. If &quot;
        &quot;&#39;Makefile&#39; is passed in, a file called &#39;Macros.make&#39; &quot;
        &quot;is generated. If &#39;CMake&#39; is passed in, a file called &quot;
        &quot;&#39;Macros.cmake&#39; is generated. This option can be &quot;
        &quot;specified multiple times to generate multiple files. &quot;
        &quot;If not used at all, Macros generation is skipped. &quot;
        &quot;Note that Depends files are currently always in &quot;
        &quot;Makefile format, regardless of this option.&quot;,
    )
    parser.add_argument(
        &quot;--output-dir&quot;,
        default=os.getcwd(),
        help=&quot;The directory to write files to. If not &quot;
        &quot;specified, defaults to the current working directory.&quot;,
    )

    parser.add_argument(
        &quot;--compiler&quot;,
        &quot;-compiler&quot;,
        help=&quot;Specify a compiler. &quot;
        &quot;To see list of supported compilers for each machine, use the utility query_config in this directory&quot;,
    )

    parser.add_argument(
        &quot;--mpilib&quot;,
        &quot;-mpilib&quot;,
        help=&quot;Specify the mpilib. &quot;
        &quot;To see list of supported mpilibs for each machine, use the utility query_config in this directory. &quot;
        &quot;The default is the first listing in MPILIBS in config_machines.xml&quot;,
    )

    parser.add_argument(
        &quot;--clean&quot;,
        action=&quot;store_true&quot;,
        help=&quot;Remove old Macros and env files before attempting to create new ones&quot;,
    )

    parser.add_argument(
        &quot;--comp-interface&quot;,
        default=&quot;mct&quot;,
        help=&quot;&quot;&quot;The cime driver/cpl interface to use.&quot;&quot;&quot;,
    )

    argcnt = len(args)
    args = parser.parse_args()
    CIME.utils.parse_args_and_handle_standard_logging_options(args)

    opts = {}
    if args.machines_dir is not None:
        machines_file = os.path.join(args.machines_dir, &quot;config_machines.xml&quot;)
        machobj = Machines(infile=machines_file, machine=args.machine)
    else:
        model = get_model()
        if model is not None:
            machobj = Machines(machine=args.machine)
        else:
            expect(
                False,
                &quot;Either --mach-dir or the CIME_MODEL environment &quot;
                &quot;variable must be specified!&quot;,
            )

    opts[&quot;machobj&quot;] = machobj

    if args.macros_format is None:
        opts[&quot;macros_format&quot;] = []
    else:
        opts[&quot;macros_format&quot;] = args.macros_format

    expect(
        os.path.isdir(args.output_dir),
        &quot;Output directory &#39;%s&#39; does not exist.&quot; % args.output_dir,
    )

    opts[&quot;output_dir&quot;] = args.output_dir

    # Set compiler.
    if args.compiler is not None:
        compiler = args.compiler
    elif &quot;COMPILER&quot; in os.environ:
        compiler = os.environ[&quot;COMPILER&quot;]
    else:
        compiler = machobj.get_default_compiler()
        os.environ[&quot;COMPILER&quot;] = compiler
    expect(
        opts[&quot;machobj&quot;].is_valid_compiler(compiler),
        &quot;Invalid compiler vendor given in COMPILER environment variable: %s&quot; % compiler,
    )
    opts[&quot;compiler&quot;] = compiler
    opts[&quot;os&quot;] = machobj.get_value(&quot;OS&quot;)
    opts[&quot;comp_interface&quot;] = args.comp_interface

    if args.clean:
        files = [
            &quot;Macros.make&quot;,
            &quot;Macros.cmake&quot;,
            &quot;env_mach_specific.xml&quot;,
            &quot;.env_mach_specific.sh&quot;,
            &quot;.env_mach_specific.csh&quot;,
            &quot;Depends.%s&quot; % compiler,
            &quot;Depends.%s&quot; % args.machine,
            &quot;Depends.%s.%s&quot; % (args.machine, compiler),
        ]
        for file_ in files:
            if os.path.isfile(file_):
                logger.warn(&quot;Removing file %s&quot; % file_)
                os.remove(file_)
        if argcnt == 2:
            opts[&quot;clean_only&quot;] = True
            return opts

    # Set MPI library.
    if args.mpilib is not None:
        mpilib = args.mpilib
    elif &quot;MPILIB&quot; in os.environ:
        mpilib = os.environ[&quot;MPILIB&quot;]
    else:
        mpilib = machobj.get_default_MPIlib(attributes={&quot;compiler&quot;: compiler})
        os.environ[&quot;MPILIB&quot;] = mpilib

    expect(
        opts[&quot;machobj&quot;].is_valid_MPIlib(mpilib, attributes={&quot;compiler&quot;: compiler}),
        &quot;Invalid MPI library name given in MPILIB environment variable: %s&quot; % mpilib,
    )
    opts[&quot;mpilib&quot;] = mpilib

    # Set DEBUG flag.
    if &quot;DEBUG&quot; in os.environ:
        expect(
            os.environ[&quot;DEBUG&quot;].lower() in (&quot;true&quot;, &quot;false&quot;),
            &quot;Invalid DEBUG environment variable value (must be &#39;TRUE&#39; or &quot;
            &quot;&#39;FALSE&#39;): %s&quot; % os.environ[&quot;DEBUG&quot;],
        )
        debug = os.environ[&quot;DEBUG&quot;].lower() == &quot;true&quot;
    else:
        debug = False
        os.environ[&quot;DEBUG&quot;] = &quot;FALSE&quot;
    opts[&quot;debug&quot;] = debug

    return opts


def _main():
    opts = parse_command_line(sys.argv)
    if &quot;clean_only&quot; not in opts or not opts[&quot;clean_only&quot;]:
        configure(
            opts[&quot;machobj&quot;],
            opts[&quot;output_dir&quot;],
            opts[&quot;macros_format&quot;],
            opts[&quot;compiler&quot;],
            opts[&quot;mpilib&quot;],
            opts[&quot;debug&quot;],
            opts[&quot;comp_interface&quot;],
            opts[&quot;os&quot;],
        )


if __name__ == &quot;__main__&quot;:
    _main()
</pre></div>
</div>
<p>Give the file permission s to execute:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM/cime/tools]$ chmod +x configure
</pre></div>
</div>
<p>go to ~/WRF-CTSM/CTSM/cime/tools/mapping/gen_domain_files/src and run it from there</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM/cime/tools/mapping/gen_domain_files/src]$ ../../../configure --machine fram --compiler intel --mpilib impi --macros-format Makefile

[~/WRF-CTSM/CTSM/cime/tools/mapping/gen_domain_files/src]$ . ./.env_mach_specific.sh ; make
</pre></div>
</div>
<p>move one folder up and renerate the domain with the mapping file as input :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/WRF-CTSM/CTSM/cime/tools/mapping/gen_domain_files/src]$ cd ..
[~/WRF-CTSM/CTSM/cime/tools/mapping/gen_domain_files]$ ./gen_domain -m ~/WRF-CTSM/CTSM/tools/mkmapdata/wrf2clm_mapping.nc -o wrf2clm_ocn_noneg -l wrf2clm_lnd_noneg
</pre></div>
</div>
</section>
<section id="generating-surface-data">
<h3>Generating Surface data<a class="headerlink" href="#generating-surface-data" title="Permalink to this heading"></a></h3>
<p>cd to ~/WRF-CTSM/CTSM/tools/mksurfdata_map/src and edit Makefile.common change lines 33 and 37: sp they say;</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>LIB_NETCDF := /cluster/software/netCDF-Fortran/4.6.0-iimpi-2022a/lib
INC_NETCDF := /cluster/software/netCDF-Fortran/4.6.0-iimpi-2022a/include
</pre></div>
</div>
<p>laod NETcdf module and make:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[~/wrf-ctsm/CTSM/tools/mksurfdata_map/src]$ ml netCDF-Fortran/4.6.0-iimpi-2022a
[~/wrf-ctsm/CTSM/tools/mksurfdata_map/src]$ gmake
[~/wrf-ctsm/CTSM/tools/mksurfdata_map/src]$ cd ..
</pre></div>
</div>
<p>edit mksurfdata.pl line 830 so that it says (just remove the underscore):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (index($res, &#39;1x1&#39;) != -1) {
</pre></div>
</div>
<p>and run mksurfdata.pl to create surface files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./mksurfdata.pl -res usrspec -usr_gname &quot;1x1&quot; -usr_gdate &quot;240208&quot; -usr_mapdir &quot;/cluster/home/$USER/WRF-CTSM/CTSM/tools/mkmapdata&quot; -y 2000 -exedir &quot;/cluster/home/$USER/WRF-CTSM/CTSM/tools/mksurfdata_map&quot; -no-crop -dinlc /cluster/shared/noresm/inputdata
</pre></div>
</div>
<p>“1x1” denotes the regional run, “240208” should be changed according to the date when mapping files resulting from ./regridbatch.sh were created which can be checked in their .nc names under /cluster/home/$USER/WRF-CTSM/CTSM/tools/mkmapdata, “-y 2000” refers to the present day year, “-dinlc” denotes the location of the rawdata</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../spinup/" class="btn btn-neutral float-left" title="Spin-up CTSM" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../develop/" class="btn btn-neutral float-right" title="Tips for developing CTSM" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, CTSM-Norway team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>